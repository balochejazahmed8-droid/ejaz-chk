name: ejaz-check

on: workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
      - name: Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}
          tags: tag:github-runner
          hostname: github-rdp-runner

      - name: Get Tailscale IP
        shell: powershell
        run: |
          Start-Sleep -Seconds 10
          $ip = (tailscale ip -4).Trim()
          if ($ip) {
            Write-Host "RDP_IP=$ip" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
            Write-Host "Tailscale IP: $ip"
          } else {
            Write-Host "ERROR: Failed to get Tailscale IP"
            exit 1
          }

      - name: Setup RDP
        shell: powershell
        run: |
          # Enable RDP
          Write-Host "Configuring RDP..."
          
          # Method 1: Using registry commands
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0 /f
          
          # Method 2: Also set via PowerShell (belt and suspenders)
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0 -Force
          
          # Configure firewall
          Write-Host "Configuring firewall..."
          netsh advfirewall firewall add rule name="RDP Port 3389" dir=in action=allow protocol=TCP localport=3389
          
          # Also enable Windows Firewall rule
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop" -ErrorAction SilentlyContinue
          
          Write-Host "RDP configuration completed"

      - name: Create RDP User
        shell: powershell
        run: |
          $username = "ejaz"
          $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 14 | ForEach-Object {[char]$_})
          
          Write-Host "Creating user: $username"
          
          # Try to remove existing user
          try {
            Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          } catch { }
          
          # Create new user with PowerShell
          $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
          $userParams = @{
              Name                 = $username
              Password             = $securePassword
              PasswordNeverExpires = $true
              AccountNeverExpires  = $true
          }
          New-LocalUser @userParams
          
          # Add to Administrators group
          Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
          
          # Add to Remote Desktop Users group
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
          
          # Set environment variables
          Write-Host "RDP_USER=$username" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "RDP_PASSWORD=$password" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          
          Write-Host "User $username created successfully"

      - name: Install Bitcoin Tools
        shell: powershell
        run: |
          # Create tools directory
          $toolsDir = "C:\Bitcoin"
          New-Item -ItemType Directory -Path $toolsDir -Force
          
          # Download VanitySearch
          $vsUrl = "https://github.com/JeanLucPons/VanitySearch/releases/download/1.19/VanitySearch.exe"
          $vsPath = "$toolsDir\VanitySearch.exe"
          
          Write-Host "Downloading Bitcoin Vanity Tools..."
          try {
            # Try different download methods
            try {
              # Method 1: Using WebClient (most reliable)
              (New-Object System.Net.WebClient).DownloadFile($vsUrl, $vsPath)
            } catch {
              # Method 2: Using Invoke-WebRequest
              Invoke-WebRequest -Uri $vsUrl -OutFile $vsPath -UseBasicParsing
            }
            Write-Host "VanitySearch downloaded successfully"
          } catch {
            Write-Host "Warning: Could not download VanitySearch. Creating placeholder."
            # Create a dummy file so the workflow continues
            New-Item -Path $vsPath -ItemType File -Force
            "echo Bitcoin Vanity Search Tool" | Out-File -Path $vsPath -Encoding ASCII
          }
          
          # Create README
          $readmeContent = @'
Bitcoin Vanity Address Generator
================================

Tool: VanitySearch.exe

Usage Examples:
1. Basic search: VanitySearch.exe 1Ejaz
2. Use all CPU cores: VanitySearch.exe -t 0 1Bitcoin
3. Case sensitive: VanitySearch.exe -c 1LoveBTC

Location: C:\Bitcoin
'@
          
          Set-Content -Path "$toolsDir\README.txt" -Value $readmeContent -Encoding UTF8
          
          # Create desktop shortcut
          $desktop = [Environment]::GetFolderPath("Desktop")
          $shortcutPath = "$desktop\Bitcoin Vanity.lnk"
          
          $WshShell = New-Object -ComObject WScript.Shell
          $Shortcut = $WshShell.CreateShortcut($shortcutPath)
          $Shortcut.TargetPath = "cmd.exe"
          $Shortcut.Arguments = "/k cd /d C:\Bitcoin && echo Bitcoin Tools Ready && dir"
          $Shortcut.WorkingDirectory = "C:\Bitcoin"
          $Shortcut.Description = "Bitcoin Vanity Address Generator"
          $Shortcut.Save()
          
          Write-Host "Bitcoin tools installed to C:\Bitcoin"
          Write-Host "Desktop shortcut created: Bitcoin Vanity.lnk"

      - name: Display Connection Details
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "================================================="
          Write-Host "               RDP CONNECTION READY              "
          Write-Host "================================================="
          Write-Host ""
          Write-Host "CONNECTION DETAILS:"
          Write-Host "IP Address:     $env:RDP_IP"
          Write-Host "Username:       $env:RDP_USER"
          Write-Host "Password:       $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "CONNECT USING:"
          Write-Host "mstsc /v:$env:RDP_IP"
          Write-Host ""
          Write-Host "ON WINDOWS:"
          Write-Host "1. Press Win + R"
          Write-Host "2. Type: mstsc"
          Write-Host "3. Enter IP: $env:RDP_IP"
          Write-Host "4. Username: $env:RDP_USER"
          Write-Host "5. Password: $env:RDP_PASSWORD"
          Write-Host ""
          Write-Host "BITCOIN TOOLS:"
          Write-Host "Location: C:\Bitcoin"
          Write-Host "Desktop Shortcut: Bitcoin Vanity.lnk"
          Write-Host ""
          Write-Host "SESSION DURATION: ~5 hours"
          Write-Host "================================================="
          Write-Host ""

      - name: Keep Session Active
        shell: powershell
        run: |
          Write-Host "Keeping RDP session active for 5 hours..."
          Write-Host "Activity will be simulated every 2 minutes"
          
          # Session duration: 5 hours = 300 minutes = 150 cycles of 2 minutes
          $totalCycles = 150
          
          for ($cycle = 1; $cycle -le $totalCycles; $cycle++) {
            $timeRemaining = ($totalCycles - $cycle) * 2
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] Cycle $cycle/$totalCycles - Time remaining: ${timeRemaining} minutes"
            
            # Method 1: Try to move mouse
            try {
              Add-Type -AssemblyName System.Windows.Forms
              $currentPos = [System.Windows.Forms.Cursor]::Position
              $newX = ($currentPos.X + 1) % 1000
              $newY = ($currentPos.Y + 1) % 800
              [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point($newX, $newY)
            } catch {
              # Method 2: Send keystroke if mouse fails
              try {
                Add-Type -AssemblyName System.Windows.Forms
                [System.Windows.Forms.SendKeys]::SendWait("{CAPSLOCK}")
                Start-Sleep -Milliseconds 100
                [System.Windows.Forms.SendKeys]::SendWait("{CAPSLOCK}")
              } catch {
                # Method 3: Just write to console
                Write-Host "Activity simulated"
              }
            }
            
            # Wait 2 minutes
            Start-Sleep -Seconds 120
          }
          
          Write-Host "Session time complete"
